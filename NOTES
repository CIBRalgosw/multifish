# for us-east-1
# use ami-0cce120e74c5100d4 for the CPU compute environment
# use ami-0c885adf297004c8c for the GPU compute environment

# for other regions check https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-optimized_AMI.html
# for AMI ids
sudo yum update -y
sudo amazon-linux-extras install -y epel
sudo yum install -y yum-utils pciutils wget fuse s3fs-fuse bzip2 nfs-utils

# install aws-cli using miniconda
wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh -b -f -p $HOME/miniconda
$HOME/miniconda/bin/conda install -c conda-forge -y awscli
rm Miniconda3-latest-Linux-x86_64.sh

# change fs-509941e4:/ to your EFS volume ID and access point
sudo mkdir /efs-multifish
sudo echo -e 'fs-509941e4:/\t/efs-multifish\tefs\trw,_netdev\t0\t0' | sudo tee -a /etc/fstab

# change janelia-nextflow-demo:/multifish to your bucket and folder
sudo mkdir /s3-multifish
sudo echo -e 's3fs#janelia-nextflow-demo:/multifish\t/s3-multifish\tfuse\trw,_netdev,use_path_request_style,allow_other,umask=0000,iam_role=auto,kernel_cache,max_background=1000,max_stat_cache_size=100000,multipart_size=52,parallel_count=30,dbglevel=warn\t0\t0' | sudo tee -a /etc/fstab

sudo mount â€“a

# on the instance for the GPU environment
# /usr/libexec/docker/docker-setup-runtimes.sh already exists so you can simply edit it 
# and add the `echo -n "--default-runtime nvidia "` line in order to set the default runtime for docker
sudo cat > /usr/libexec/docker/docker-setup-runtimes.sh <<EOF
#!/bin/sh
{
    echo -n "DOCKER_ADD_RUNTIMES=\""
    for file in /etc/docker-runtimes.d/*; do
        [ -f "$file" ] && [ -x "$file" ] && echo -n "--add-runtime $(basename "$file")=$file "
    done
    echo -n "--default-runtime nvidia "
    echo "\""
} > /run/docker/runtimes.env
EOF

sudo systemctl stop ecs
sudo rm -rf /var/lib/ecs/data/agent.db
